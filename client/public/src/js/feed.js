const shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image");let picture;const locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader");let fetchedLocation={lat:0,lng:0};const initializeLocation=()=>{"geolocation"in navigator||(locationBtn.style.display="none",locationLoader.style.display="none")};locationBtn.addEventListener("click",e=>{if(!("geolocation"in navigator))return;let t=!1;locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(e=>{locationBtn.style.display="inline",locationLoader.style.display="none",fetchedLocation={lat:e.coords.latitude,lng:e.coords.longitude},locationInput.value="In Ocean!",document.querySelector("#manual-location").classList.add("is-focused")},e=>{locationBtn.style.display="inline",locationLoader.style.display="none",t||(alert("Couldn't fetch location, please enter manually!"),t=!0),fetchedLocation={lat:0,lng:0}},{timeout:7e3})});const initializeMedia=async()=>{"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=(e=>{const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return t?new Promise((a,o)=>{t.call(navigator,e,a,o)}):Promise.reject(new Error("getUserMedia is not implemented!"))}));try{const e=await navigator.mediaDevices.getUserMedia({video:!0});videoPlayer.srcObject=e,videoPlayer.style.display="block"}catch(e){imagePickerArea.style.display="block"}};captureButton.addEventListener("click",e=>{canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvasElement.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasElement.width)),videoPlayer.srcObject.getVideoTracks().forEach(e=>e.stop()),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",e=>{picture=e.target.files[0]});const openCreatePostModal=()=>{setTimeout(()=>{createPostArea.style.transform="translateY(0)"},1),(async()=>await initializeMedia())(),"geolocation"in navigator||(locationBtn.style.display="none",locationLoader.style.display="none"),defferedPrompt&&(async()=>{try{defferedPrompt.prompt();const{outcome:e}=await defferedPrompt.userChoice;defferedPrompt=null}catch(e){}})()},closeCreatePostModal=()=>{videoPlayer.style.display="none",imagePickerArea.style.display="none",canvasElement.style.display="none",captureButton.style.display="inline",videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(e=>e.stop()),setTimeout(()=>{createPostArea.style.transform="translateY(100vh)"},1),locationBtn.style.display="inline",locationLoader.style.display="none"};shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);const clearCards=()=>{for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)},createCard=e=>{const t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp";const a=document.createElement("div");a.className="mdl-card__title",a.style.backgroundImage=`url("${BACKEND_APP_URI}/${e.image}")`,a.style.backgroundSize="cover",a.style.backgroundPosition="center",t.appendChild(a);const o=document.createElement("h2");o.style.color="white",o.className="mdl-card__title-text",o.textContent=e.title,a.appendChild(o);const n=document.createElement("div");n.className="mdl-card__supporting-text",n.textContent=e.location,n.style.textAlign="center",t.appendChild(n),componentHandler.upgradeElement(t),sharedMomentsArea.prepend(t)},updateUI=e=>{clearCards(),e.forEach(e=>createCard(e))};let networkDataReceived=!1;(async()=>{try{const e=await fetch(`${BACKEND_APP_URI}/posts`),t=await e.json();networkDataReceived=!0,updateUI(t.posts)}catch(e){}})(),"indexedDB"in window&&(async()=>{try{const e=await readAllData(POSTS_OBJECT_STORE);networkDataReceived||updateUI(e)}catch(e){}})();const sendData=async e=>{const t=new FormData;t.append("title",e.title),t.append("location",e.location),t.append("image",e.image,e.title+".png"),t.append("rawLocationLat",e.rawLocationLat),t.append("rawLocationLng",e.rawLocationLng);try{const e=await fetch(`${BACKEND_APP_URI}/posts`,{method:"POST",body:t}),{post:a}=await e.json();createCard(a)}catch(e){}};form.addEventListener("submit",async e=>{e.preventDefault();const t=titleInput.value.trim(),a=locationInput.value.trim();if(""===t||""===a)return void alert("Please enter a valid data!");titleInput.value="",locationInput.value="",closeCreatePostModal();const o={title:t,location:a,image:picture,rawLocationLat:fetchedLocation.lat,rawLocationLng:fetchedLocation.lng};if("serviceWorker"in navigator&&"SyncManager"in window)try{await writeData(POSTS_SYNC_OBJECT_STORE,o);const e=await navigator.serviceWorker.ready;await e.sync.register(POSTS_SYNC_TAG);const t=document.querySelector("#confirmation-toast"),a={message:"Your post was saved for syncing!"};t.MaterialSnackbar.showSnackbar(a)}catch(e){}else await sendData(o)}),(async()=>{try{"granted"===(await navigator.permissions.query({name:"periodic-background-sync"})).state&&"serviceWorker"in navigator&&(console.log("Permission Granted for Periodic Sync"),(async()=>{try{const e=await navigator.serviceWorker.ready;if("periodicSync"in e){await e.periodicSync.getTags();await e.periodicSync.register(POSTS_PERIODIC_SYNC_TAG,{minInterval:3e4})}}catch(e){}})())}catch(e){}})();